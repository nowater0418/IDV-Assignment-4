<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adversarial Robustness Matrix | IDV Assignment 4</title>
    <!-- 引入 Google Fonts 字体，提升排版质感 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- 引入 D3.js 库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* --- 1. 基础页面样式设置 (深色主题) --- */
        body {
            font-family: 'Inter', sans-serif; /* 使用现代无衬线字体 */
            background-color: #0f172a; /* 深蓝黑背景 */
            color: #e2e8f0; /* 浅灰文字 */
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* 标题区域样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            max-width: 800px;
        }

        h1 {
            font-weight: 600;
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            background: linear-gradient(90deg, #60a5fa, #c084fc); /* 渐变色文字标题 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        h3 {
            font-weight: 300;
            color: #94a3b8;
            font-size: 1rem;
            margin: 0;
        }

        /* --- 2. 控制面板样式 (卡片式设计) --- */
        .controls-panel {
            background: #1e293b; /* 比背景稍亮的卡片色 */
            border: 1px solid #334155;
            padding: 20px 30px;
            border-radius: 16px; /* 大圆角 */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .label-text {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
        }

        /* 按钮样式 - 科技感幽灵按钮 */
        button {
            background-color: transparent;
            color: #38bdf8;
            border: 1px solid #38bdf8;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
        }

        button:hover {
            background-color: rgba(56, 189, 248, 0.1);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); /* 发光效果 */
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* 自定义滑动条样式 */
        input[type=range] {
            -webkit-appearance: none; /* 去除默认样式 */
            width: 140px;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #c084fc;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(192, 132, 252, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }

        /* --- 3. 图表容器样式 --- */
        #chart-container {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            /* 确保 SVG 居中 */
            display: flex;
            justify-content: center;
        }

        /* Tooltip 样式 - 毛玻璃效果 */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 12px;
            font-size: 13px;
            background: rgba(15, 23, 42, 0.8); /* 半透明深色 */
            border: 1px solid #475569;
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            backdrop-filter: blur(8px); /* 毛玻璃 */
            z-index: 100;
            line-height: 1.5;
        }

        /* D3 元素样式覆盖 */
        .axis text { 
            font-size: 11px; 
            fill: #94a3b8; /* 浅灰色坐标轴文字 */
            font-family: 'Inter', sans-serif;
        }
        
        .axis path, .axis line { display: none; } /* 隐藏坐标轴线，只留文字 */
        
        /* 高亮样式 */
        .axis text.active {
            font-weight: 700;
            fill: #38bdf8; /* 亮蓝色高亮 */
            font-size: 12px;
            text-shadow: 0 0 8px rgba(56, 189, 248, 0.5);
        }

        /* 图例文字 */
        .legend-text {
            fill: #94a3b8;
            font-size: 12px;
        }

        .label-main {
            fill: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }

    </style>
</head>
<body>

    <!-- 顶部标题区域 -->
    <header>
        <h1>Adversarial Defense Matrix</h1>
        <h3>Interactive visualization of Model Robustness vs. Attack Methods</h3>
    </header>

    <!-- 控制面板区域 -->
    <div class="controls-panel">
        <div class="control-group">
            <span class="label-text">Sorting:</span>
            <button id="btn-orig">Reset Order</button>
            <button id="btn-best-model">Top Models</button>
            <button id="btn-hard-attack">Effective Attacks</button>
        </div>

        <div style="width: 1px; height: 30px; background: #334155; margin: 0 10px;"></div> <!-- 分割线 -->

        <div class="control-group">
            <span class="label-text">Threshold Filter (<span id="slider-val" style="color: #c084fc;">0</span>):</span>
            <input type="range" id="filterSlider" min="0" max="100" value="0" step="1">
        </div>
    </div>
    
    <!-- 图表绘图区域 -->
    <div id="chart-container"></div>
    
    <!-- 悬浮提示框容器 -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        /**
         * ---------------------------------------------------------
         * 1. 数据准备 (Data Preparation)
         *    这里保持了之前正确的数据源和格式转换逻辑。
         * ---------------------------------------------------------
         */
        const rawData = [
            {Attack: "No Attack", ERM: 94.85, DA: 94.21, PGDT: 84.38, TRADES: 80.42, MART: 81.54, RS: 89.45, IBP: 48.40, PRL: 93.82, TandT: 94.23},
            {Attack: "TIFGSM", ERM: 35.10, DA: 33.00, PGDT: 65.70, TRADES: 62.90, MART: 69.10, RS: 45.40, IBP: 40.20, PRL: 34.00, TandT: 92.80},
            {Attack: "MIFGSM", ERM: 0.00, DA: 0.00, PGDT: 50.90, TRADES: 51.90, MART: 50.50, RS: 5.80, IBP: 38.10, PRL: 0.00, TandT: 92.80},
            {Attack: "DIFGSM", ERM: 1.00, DA: 0.00, PGDT: 51.75, TRADES: 50.50, MART: 53.60, RS: 4.10, IBP: 38.10, PRL: 3.10, TandT: 92.80},
            {Attack: "VMIFGSM", ERM: 0.00, DA: 0.00, PGDT: 51.10, TRADES: 50.90, MART: 51.90, RS: 4.10, IBP: 38.10, PRL: 0.00, TandT: 93.90},
            {Attack: "TPGD", ERM: 38.10, DA: 39.20, PGDT: 69.30, TRADES: 69.10, MART: 70.10, RS: 48.50, IBP: 50.00, PRL: 28.90, TandT: 91.80},
            {Attack: "FGSM", ERM: 29.90, DA: 25.80, PGDT: 57.95, TRADES: 54.60, MART: 61.90, RS: 28.90, IBP: 38.10, PRL: 25.80, TandT: 93.80},
            {Attack: "RFGSM", ERM: 0.00, DA: 0.00, PGDT: 49.15, TRADES: 50.40, MART: 48.50, RS: 3.70, IBP: 38.10, PRL: 0.00, TandT: 90.00},
            {Attack: "BIM", ERM: 0.00, DA: 0.00, PGDT: 52.00, TRADES: 57.20, MART: 47.40, RS: 2.10, IBP: 38.10, PRL: 0.00, TandT: 90.70},
            {Attack: "FAB", ERM: 1.00, DA: 2.10, PGDT: 43.00, TRADES: 46.40, MART: 40.20, RS: 5.30, IBP: 38.10, PRL: 4.10, TandT: 90.10},
            {Attack: "CW", ERM: 0.00, DA: 0.00, PGDT: 32.20, TRADES: 35.10, MART: 29.90, RS: 1.00, IBP: 40.20, PRL: 1.00, TandT: 92.90},
            {Attack: "UPGD", ERM: 0.00, DA: 0.00, PGDT: 49.85, TRADES: 50.50, MART: 49.80, RS: 5.10, IBP: 38.10, PRL: 0.00, TandT: 93.80},
            {Attack: "FFGSM", ERM: 19.60, DA: 23.70, PGDT: 60.55, TRADES: 55.70, MART: 66.00, RS: 33.00, IBP: 42.30, PRL: 29.90, TandT: 92.80},
            {Attack: "Jitter", ERM: 11.30, DA: 12.40, PGDT: 48.15, TRADES: 47.40, MART: 49.50, RS: 34.00, IBP: 39.20, PRL: 24.70, TandT: 90.70},
            {Attack: "PGD", ERM: 0.00, DA: 0.00, PGDT: 57.40, TRADES: 54.60, MART: 60.80, RS: 7.20, IBP: 40.20, PRL: 0.00, TandT: 91.80},
            {Attack: "EOTPGD", ERM: 0.00, DA: 0.00, PGDT: 50.10, TRADES: 50.30, MART: 50.50, RS: 3.00, IBP: 38.10, PRL: 0.00, TandT: 90.70},
            {Attack: "APGD", ERM: 0.00, DA: 0.00, PGDT: 48.40, TRADES: 51.00, MART: 46.40, RS: 1.00, IBP: 38.10, PRL: 0.00, TandT: 90.70},
            {Attack: "NIFGSM", ERM: 0.00, DA: 0.00, PGDT: 57.95, TRADES: 56.70, MART: 59.80, RS: 7.20, IBP: 38.10, PRL: 1.00, TandT: 92.80},
            {Attack: "SiniFGSM", ERM: 4.10, DA: 1.00, PGDT: 59.00, TRADES: 56.70, MART: 61.90, RS: 23.70, IBP: 38.10, PRL: 12.40, TandT: 93.70},
            {Attack: "VNIFGSM", ERM: 0.00, DA: 0.00, PGDT: 50.45, TRADES: 53.00, MART: 48.50, RS: 5.10, IBP: 38.10, PRL: 0.00, TandT: 92.90},
            {Attack: "APGDT", ERM: 0.00, DA: 0.00, PGDT: 40.90, TRADES: 44.30, MART: 38.10, RS: 0.00, IBP: 38.10, PRL: 0.00, TandT: 88.70},
            {Attack: "Square", ERM: 0.00, DA: 1.00, PGDT: 50.40, TRADES: 54.00, MART: 47.40, RS: 3.10, IBP: 38.10, PRL: 2.10, TandT: 88.08},
            {Attack: "Add G. Noise", ERM: 25.80, DA: 43.30, PGDT: 79.10, TRADES: 78.40, MART: 80.40, RS: 74.20, IBP: 42.30, PRL: 45.40, TandT: 87.60},
            {Attack: "OnePixel", ERM: 79.40, DA: 83.50, PGDT: 78.05, TRADES: 74.20, MART: 82.50, RS: 83.50, IBP: 42.50, PRL: 80.40, TandT: 89.70},
            {Attack: "Pixle", ERM: 0.00, DA: 0.00, PGDT: 12.55, TRADES: 11.30, MART: 14.40, RS: 1.00, IBP: 10.30, PRL: 0.00, TandT: 17.50},
            {Attack: "PGDL2", ERM: 1.00, DA: 0.00, PGDT: 35.80, TRADES: 36.10, MART: 36.10, RS: 5.20, IBP: 36.10, PRL: 0.00, TandT: 92.90}
        ];

        const approaches = ["ERM", "DA", "PGDT", "TRADES", "MART", "RS", "IBP", "PRL", "TandT"];
        const attacksOriginal = rawData.map(d => d.Attack);
        
        // 计算平均值用于排序算法
        const modelStats = approaches.map(m => ({
            name: m,
            avg: d3.mean(rawData, d => d[m])
        }));

        const attackStats = rawData.map(d => {
            const vals = approaches.map(a => d[a]);
            return {
                name: d.Attack,
                avg: d3.mean(vals)
            };
        });

        // 转换为长格式以供 D3 使用
        let longData = [];
        rawData.forEach(row => {
            approaches.forEach(approach => {
                longData.push({
                    attack: row.Attack,
                    approach: approach,
                    value: row[approach]
                });
            });
        });

        /**
         * ---------------------------------------------------------
         * 2. D3 画布设置 (SVG Setup)
         * ---------------------------------------------------------
         */
        const margin = { top: 40, right: 60, bottom: 100, left: 120 };
        const width = 850 - margin.left - margin.right;
        const height = 700 - margin.top - margin.bottom;

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 比例尺定义
        const x = d3.scaleBand().range([0, width]).domain(approaches).padding(0.08); // 增加一点间距
        const y = d3.scaleBand().range([0, height]).domain(attacksOriginal).padding(0.08);
        
        // 颜色比例尺 (红-黄-绿)
        const myColor = d3.scaleSequential()
            .interpolator(d3.interpolateRdYlGn)
            .domain([0, 100]);

        /**
         * ---------------------------------------------------------
         * 3. 坐标轴绘制 (Axes Rendering)
         * ---------------------------------------------------------
         */
        const xAxisGroup = svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0, ${height})`);

        const yAxisGroup = svg.append("g")
            .attr("class", "y-axis");

        // 绘制/更新坐标轴的函数
        function renderAxes(transition) {
            let xG = transition ? xAxisGroup.transition(transition) : xAxisGroup;
            let yG = transition ? yAxisGroup.transition(transition) : yAxisGroup;

            xG.call(d3.axisBottom(x))
              .selectAll("text")
              .attr("class", "x-label")
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", ".15em")
              .attr("transform", "rotate(-45)");

            yG.call(d3.axisLeft(y))
              .selectAll("text")
              .attr("class", "y-label");
        }

        // 初始渲染
        renderAxes();

        // 添加主要的坐标轴标签
        svg.append("text")
           .attr("x", width / 2)
           .attr("y", height + margin.bottom - 10)
           .attr("text-anchor", "middle")
           .attr("class", "label-main")
           .text("Defense Approaches (Models)");

        svg.append("text")
           .attr("transform", "rotate(-90)")
           .attr("y", -margin.left + 20)
           .attr("x", -height / 2)
           .attr("dy", "1em")
           .attr("text-anchor", "middle")
           .attr("class", "label-main")
           .text("Attack Methods");

        /**
         * ---------------------------------------------------------
         * 4. 绘制热力图方块 (Drawing Heatmap Rects)
         * ---------------------------------------------------------
         */
        const rectGroup = svg.append("g").attr("class", "rects");

        const rects = rectGroup.selectAll("rect")
            .data(longData, d => d.approach + "-" + d.attack) // Key function for data binding
            .enter()
            .append("rect")
            .attr("x", d => x(d.approach))
            .attr("y", d => y(d.attack))
            .attr("rx", 3) // 小圆角
            .attr("ry", 3)
            .attr("width", x.bandwidth())
            .attr("height", y.bandwidth())
            .style("fill", d => myColor(d.value))
            .style("opacity", 0); // 初始隐藏，用于动画

        // 开场动画：波浪式浮现
        rects.transition().duration(1000)
            .delay((d, i) => i * 1.5)
            .style("opacity", 1);

        /**
         * ---------------------------------------------------------
         * 5. 交互：悬停提示框 (Interaction: Tooltip)
         * ---------------------------------------------------------
         */
        const tooltip = d3.select("#tooltip");

        rects.on("mouseover", function(event, d) {
            // 如果是被过滤器变灰的元素，不触发交互
            if (d3.select(this).style("opacity") < 0.5) return;

            // 高亮当前方格
            d3.select(this)
              .style("stroke", "#fff")
              .style("stroke-width", 2)
              .style("stroke-opacity", 0.8);
            
            // 显示 Tooltip
            tooltip.style("opacity", 1)
                .html(`
                    <div style="margin-bottom:4px; color: #94a3b8;">${d.approach} <span style="font-size:10px">vs</span> ${d.attack}</div>
                    <div style="font-size:16px; font-weight: 600; color: #fff;">
                        Score: <span style='color:${d3.interpolateRdYlGn(d.value/100)};'>${d.value.toFixed(2)}</span>
                    </div>
                `)
                .style("left", (event.pageX + 15) + "px")
                .style("top", (event.pageY - 15) + "px");

            // 高亮坐标轴文字
            svg.selectAll(".x-label").filter(t => t === d.approach).classed("active", true);
            svg.selectAll(".y-label").filter(t => t === d.attack).classed("active", true);
        })
        .on("mousemove", function(event) {
            tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 15) + "px");
        })
        .on("mouseleave", function() {
            d3.select(this).style("stroke", "none");
            tooltip.style("opacity", 0);
            svg.selectAll(".x-label, .y-label").classed("active", false);
        });

        /**
         * ---------------------------------------------------------
         * 6. 交互：排序与过滤 (Sorting & Filtering)
         * ---------------------------------------------------------
         */
        
        // 排序动画函数
        function runSort() {
            const t = svg.transition().duration(1000).ease(d3.easeCubicInOut); // 使用平滑的缓动函数

            // 1. 移动方块
            rects.transition(t)
                .attr("x", d => x(d.approach))
                .attr("y", d => y(d.attack));

            // 2. 更新坐标轴
            renderAxes(t);
        }

        // 绑定按钮事件
        d3.select("#btn-orig").on("click", () => {
            x.domain(approaches);
            y.domain(attacksOriginal);
            runSort();
        });

        d3.select("#btn-best-model").on("click", () => {
            // 按模型平均分降序排列
            const sortedModels = [...modelStats].sort((a,b) => b.avg - a.avg).map(d => d.name);
            x.domain(sortedModels);
            runSort();
        });

        d3.select("#btn-hard-attack").on("click", () => {
            // 按攻击平均分升序排列 (分越低攻击越强)
            const sortedAttacks = [...attackStats].sort((a,b) => a.avg - b.avg).map(d => d.name);
            y.domain(sortedAttacks);
            runSort();
        });

        // 绑定滑动条事件
        d3.select("#filterSlider").on("input", function() {
            const val = +this.value;
            d3.select("#slider-val").text(val);
            
            rects.transition().duration(200)
                .style("opacity", d => d.value < val ? 0.05 : 1) // 变灰程度更深，突出显示保留项
                .style("filter", d => d.value < val ? "grayscale(100%)" : "none");
        });

        /**
         * ---------------------------------------------------------
         * 7. 图例绘制 (Legend)
         * ---------------------------------------------------------
         */
        const legendHeight = 300;
        const legendWidth = 12;
        const defs = svg.append("defs");
        
        const linearGradient = defs.append("linearGradient").attr("id", "grad1");
        linearGradient.attr("x1", "0%").attr("y1", "100%").attr("x2", "0%").attr("y2", "0%");
        linearGradient.append("stop").attr("offset", "0%").attr("stop-color", myColor(0));
        linearGradient.append("stop").attr("offset", "50%").attr("stop-color", myColor(50));
        linearGradient.append("stop").attr("offset", "100%").attr("stop-color", myColor(100));

        const legend = svg.append("g")
            .attr("transform", `translate(${width + 25}, ${height/2 - legendHeight/2})`);

        // 图例条背景边框
        legend.append("rect")
              .attr("width", legendWidth)
              .attr("height", legendHeight)
              .style("fill", "url(#grad1)")
              .style("stroke", "#334155")
              .style("stroke-width", 1);
            
        const yLegend = d3.scaleLinear().range([legendHeight, 0]).domain([0, 100]);
        
        const legendAxisGroup = legend.append("g")
            .attr("transform", `translate(${legendWidth}, 0)`)
            .call(d3.axisRight(yLegend).ticks(5));
        
        // 图例文字样式修正
        legendAxisGroup.selectAll("text").attr("class", "legend-text");
        legendAxisGroup.selectAll("line").attr("stroke", "#475569");
        legendAxisGroup.selectAll("path").remove(); // 移除轴线

        legend.append("text")
              .attr("x", 0)
              .attr("y", -10)
              .text("Score")
              .attr("class", "legend-text")
              .style("font-weight", "bold");

    </script>
</body>
</html>
